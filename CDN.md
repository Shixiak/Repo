# CDN

## CDN 的概念

CDN（Content Delivery Network，内容分发网络）是指一种通过互联网相互连接的服务网络系统，利用最靠近用户的服务器，可以更快更可靠将音乐，图片，视频，应用程序及其他文件发送给用户。具有高性能，低成本，可扩展性的特点。

典型的 CDN 系统由以下三个部分组成：

* 分发服务系统
  最基本的工作单元就是 Cache 设备，cache（边缘cache）指的是直接响应最终用户的访问请求，把缓存在本地的内容快速提供给用户。同时 cache 还负责与源站点进行内容同步，把更新的内容和本地没有的内容及时从源站点获取并保存到本地。Cache 设备的数量，规模和总服务能力是衡量一个 CDN 系统服务能力的最基本的指标。
* 负载均衡系统
  主要功能是对所有发起服务请求的用户进行访问调度，确定提供给用户的最终实际访问地址。两级调度体系分为全局负载均衡（GSLB）和本地负载均衡（SLB）。全局负载均衡主要根据用户就近性原则，通过对每个服务节点进行最优性判断，确定向用户提供服务的 cache 的物理位置。本地负载均衡主要负责节点内部的设备负载均衡。
* 运营管理系统
  运营管理系统分为运营管理和网络管理子系统，负责处理业务层面与外界交互所需要的收集、整理、交付工作，包含客户管理、产品管理、计费管理、统计分析等功能。

## CDN 的作用

CDN 一般用来托管 Web 资源（如样式表，文本，脚本等），视频，文档，应用程序等。使用 CDN 来加速这些资源的访问。它的作用可以分两个方向来说：

1. 性能方面
  a. 用户可以从最近的数据中心获取需要的资料，速度更快，延迟更低。
  b. 部分资源请求分配给了 CDN，减小了服务器的负载。
2. 安全方面
  a. 针对 DDOS，CDN 可以通过监控分析异常流量，限制其请求频率。
  b. 针对 MITM，从源服务器到 CDN 节点到 ISP，全链路 HTTPS 通信。

除此之外，CDN 作为一种基础的云服务，同样具有资源托管按需扩展等方面的优势。

## CDN 的原理

CDN 和 DNS 有着密不可分的联系。

先来看一下 DNS 的域名解析过程，在浏览器输入 <www.test.com> 的解析过程如下：

1. 检查浏览器缓存。
2. 检查操作系统缓存，如 hosts 文件等。
3. 检查路由器缓存。
4. 如果前几步都没找到，会向 ISP 的 LDNS 服务器查询。
5. 如果 LDNS 没有找到，会向根域名服务器（Root Server）请求解析，分为以下几步：
  a. 根服务器返回顶级域名服务器（TLD）如 `.com`, `.cn`, `.org` 等。该例子中会返回 `.com` 顶级域名服务器的地址。
  b. 接着向顶级域名服务器发送请求，然后返回次顶级域名服务器（SLD）的地址，本例子中返回 `.test` 服务器的地址。
  c. 接着向次顶级域名服务器发送请求，然后返回通过域名查询到的 IP 地址，本例子中返回 <www.test.com> 的 IP 地址。
6. Local DNS 会将结果缓存在系统中，并将结果返回给用户。

CDN 的工作原理：

1. 用户未使用 CDN 缓存资源的过程：
    1. 浏览器通过 DNS 对域名进行解析，得到此域名的 IP 地址。
    2. 浏览器根据得到的 IP 地址，向域名的服务主机发送数据请求。
    3. 服务器向浏览器返回响应数据。
2. 用户使用 CDN 缓存资源的过程：
    ![20250611124413](https://kat-tc.oss-cn-chengdu.aliyuncs.com/img/20250611124413.png)
    1. 对于点击数据的 URL，经过本地 DNS 的解析，发现 URL 对应的是一个 CDN 专用的 DNS 服务器，DNS 服务器就会将域名解析权交给 CNAME 指向的 CDN 专用的服务器。（CNAME（别名）：在域名解析中，实际解析出来的结果是该域名对应的 IP 地址或者该域名对应的一个别名CNAME，再根据这个别名查找对应的 IP 地址。）
    2. CDN 专用 DNS 服务器会将 CDN 全局负载均衡设备的 IP 地址返回。
    3. 用户向 CDN 的全局负载均衡设备发起数据请求。
    4. CDN 的全局负载均衡设备根据用户的 IP 地址，以及用户请求的内容 URL，选择一台用户所属区域的区域负载均衡设备，向用户返回这个地址，让用户向这台设备发起请求。
    5. 区域负载均衡设备选择一台合适的缓存服务器，用户将这台缓存服务器的地址返回给全局负载均衡设备。
    6. 全局负载均衡设备把缓存服务器的地址返回给用户。
    7. 用户向缓存服务器发起数据请求，缓存服务器响应用户的请求，返回响应数据给用户。
如果缓存服务器中没有用户所需的资源，缓存服务器就会向上一级缓存服务器去请求数据，直至获取到需要的资源。最后如果还是没有，就会回到自己的服务器去获取资源。

## CDN 的使用场景

CDN 常见的使用场景如下：

1. 使用第三方的 CDN 服务：如果想要开源一些项目，可以使用第三方的 CDN 服务。
2. 使用 CDN 进行静态资源的缓存：将自己网站的静态资源，如 css、js、图片等。可以将整个项目放在 CDN 上，完成一件部署。
3. 直播传送：直播传送的本质是流媒体传送，CDN 也是支持流媒体传送的。所以直播完全可以使用 CDN 提高访问速度。CDN 在处理流媒体文件的时候与静态文件有所不同。普通文件如果在边缘节点没有，就会往上一层 CDN 去查找；但是流媒体本身数据量非常大，如果采用回源的方式，会带来性能问题，所以流媒体主要采用主动推送的方式进行。
