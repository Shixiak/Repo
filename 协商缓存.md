# 协商缓存

## 简介

协商缓存是一种需要和服务器“确认”资源是否更新的缓存策略。与强缓存不同，它不会直接无条件使用本地缓存，而是通过条件请求与服务器交互：

* 如果服务器判断资源未修改 → 返回 `304 Not Modified`，浏览器继续使用本地缓存；
* 如果服务器判断资源已修改 → 返回 `200 OK` 和最新内容，浏览器更新本地缓存。

因此，协商缓存的优点是 避免缓存失效导致的错误，同时也能减少不必要的数据传输。

## 协商缓存的关键实现方式

### Last-Modified/If-Modified-Since

服务器响应时返回：

```yaml
Last-Modified: Wed, 27 Aug 2025 06:50:00 GMT
```

表示资源最后修改的时间。

浏览器下次请求时带上：

```yaml
If-Modified-Since: Wed, 27 Aug 2025 06:50:00 GMT
```

服务器判断逻辑：

若文件自该时间后 未修改 → 返回 `304 Not Modified`（无消息体）；

若已修改 → 返回 `200 OK` 和新资源。

缺点：时间粒度为 **秒**，如果资源在 1 秒内多次修改，可能检测不到；且依赖服务器时间准确性。

### ETag/If-None-Match

ETag 是服务器生成的资源唯一标识符（通常是文件内容的哈希或版本号）。

服务器响应时返回：

```yaml
ETag: "abc123xyz"
```

浏览器下次请求时带上：

```yaml
If-None-Match: "abc123xyz"
```

服务器判断逻辑：

* 若 ETag 一致 → 返回 `304 Not Modified`；
* 若 不一致 → 返回 `200 OK` 和新内容。

优点：精确度高，不依赖时间；
缺点：服务器需要额外计算开销（如生成哈希）。

## 工作机制示例

浏览器 **首次** 请求资源

服务器响应头返回：

```yaml
Cache-Control: no-cache
ETag: "abc123"
Last-Modified: Wed, 27 Aug 2025 06:50:00 GMT
```

浏览器还是会把资源（文件 + 头部信息）保存到本地缓存。

浏览器 **再次请求同一资源** 时

因为 `no-cache`，浏览器不会直接使用本地缓存，而是构造一个条件请求：

```yaml
If-None-Match: "abc123"
If-Modified-Since: Wed, 27 Aug 2025 06:50:00 GMT
```

服务器收到请求后

* 如果内容没变 → 返回 `304 Not Modified`，浏览器就继续用本地缓存的副本。

* 如果内容有变 → 返回 `200 OK`，并带上新内容，更新本地缓存。

## 相关链接

[ETag](./ETag.md)
