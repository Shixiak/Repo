# 事件循环和任务队列

## 概述

JS 本身是单线程语言，但通过事件循环机制实现了非阻塞的异步处理能力。其核心组成包括：调用栈（Call Stack），任务队列（Task Queue），事件循环（Event Loop）。

## 任务队列

任务分两类：

### 宏任务（MacroTask）

也称作大任务，每一轮事件循环执行一个宏任务。

| 类型 | 说明 |
| :---: | :---: |
| `setTimeout(fn)` | 定时器 |
| `setInterval(fn)` | 定时器 |
| `setImmediate(fn)` | Node.js 中的立即任务 |
| `requestAnimationFrame` | 渲染前回调（浏览器） |
| `I/O` 回调 | 读写文件、网络等 |

### 微任务（MicroTask）

宏任务执行完成后，立即执行所有微任务，才进入下一轮事件循环。

| 类型 | 说明 |
| :---: | :---: |
| `Promise.then/catch/finally` | Promise 异步回调 |
| `queueMicrotask()` | 原生 API |
| `MutationObserver` | 监听 DOM 变化（浏览器） |
| `process.nextTick` | Node.js 特有（更快执行） |

## 事件循环（Event Loop）

一个事件循环的步骤如下：

1. 从宏任务队列中取出一个宏任务，放入调用栈中执行。
2. 执行同步代码。
3. 执行过程中如果产生了微任务，记录入微任务队列。
4. 当面宏任务队列执行完后，立即清空微任务队列。
5. 开始下一轮事件循环。

### 示例说明

```js
console.log("start");

setTimeout(() => {
  console.log("timeout");
}, 0);

Promise.resolve()
  .then(() => {
    console.log("promise1");
  })
  .then(() => {
    console.log("promise2");
  });

console.log("end");
```
