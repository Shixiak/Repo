# 连接云服务器教程

记录一下 VSCode 连接云服务器的过程，备忘。

## Remote - SSH

连接远程服务器需要用到 Remote - SSH 这个插件，VSCode 一般会自带，如果没有的话装一下就好了。

搜索并安装第一个, 下面两个会自动帮你装好。

![20241224094249](https://i-blog.csdnimg.cn/img_convert/bd75452cd765a92b80305f92ee10c8d7.png)

## 配置 config

配置的格式为:

```yaml
Host host1 # 主机的别名
    HostName  121.37.44.245  # 主机的 IP
    User root  ## 要通过 ssh 登陆的用户
```

Host: 显示的名字, 取个自己记得住的就行
HostName: 填服务器的 IP 地址
User: 要通过 ssh 登陆的用户, **用户必须是服务器上存在的! 用户必须是服务器上存在的! 用户必须是服务器上存在的!**

![PixPin_2024-12-24_10-11-24](https://i-blog.csdnimg.cn/img_convert/8980ab910b3fa997ecc5f87fc01ab155.gif)

## 连接

点击连接目标服务器, 输入密码; 

如果你遇到报错, 请看**报错自查**部分, 可能会给你答案.

第一次登陆时, 服务器会下载 VScode Server, 这是正常的.

左下角出现服务器的别名, 说明登陆成功.

![PixPin_2024-12-24_10-37-16](https://i-blog.csdnimg.cn/img_convert/8d2d938d6a1577af5cf6e191f27b0c86.gif)

## 配置密钥免密登录

### 密钥生成

在你的本机的 C:\Users\UserName(替换成你自己的)\.ssh 路径下查看是否密钥对, 如果不存在请先生成

密钥对  
![20241224105453](https://i-blog.csdnimg.cn/img_convert/eff1e498b2ea59f6d6653450a3d7d668.png)

在该目录下, 按住Shift, 右键空白处, 在此处打开 PowerShell 窗口
执行命令 `ssh-keygen -t rsa`
一路回车, 出现 RSA说明密钥对生成成功

![PixPin_2024-12-24_10-53-34](https://i-blog.csdnimg.cn/img_convert/5e8f98aa081381cb26199bf64fa8d3f2.gif)
### 发送公钥到服务器

**方法一:**

1. 如果你的电脑上安装有 Git Bash, 直接在当前文件夹打开 Git Bash
2. 输入命令 `ssh-copy-id host别名`, 你可能会在其他教程中看到命令 `ssh-copy-id user@hostname`, 两者都是对的, 但是由于你已经在 .ssh/config 里面配置了别名对应的 user 和 hostname, 所以这里只需要用 host 别名就行了.
![PixPin_2024-12-24_11-29-24](https://i-blog.csdnimg.cn/img_convert/4b7e09525915a7e0d019bcb19f8e992f.gif)

**方法二:**

1. 使用文本编辑器打开公钥并复制, 使用VSCode 通过密码连接到你的云服务器
2. 使用 ctrl+j 打开终端, 执行命令 `echo "你的公钥" >> ~/.ssh/authorized_keys`, 公钥外面的引号是必要的, 由于我通过方式一已经执行过了, 这里就不在演示了.

### ssh登陆

完成上述步骤, 你应该可以通过 SSH 登陆到你的云服务器, 在 powershell 使用命令 `ssh 别名` 来自查.

![PixPin_2024-12-24_11-39-06](https://i-blog.csdnimg.cn/img_convert/c6489fe7c4d723a0b157d7962297aaa7.gif)

### 配置免密登录

在 config 文件中追加 `IdentityFile ~/.ssh/id_rsa`, 保存并刷新, 你应该可以直接连接云服务器而不再需要输入密码。

![20241224114221](https://i-blog.csdnimg.cn/img_convert/e6abddb371bc475fdfcfcbed1bc20dad.png)

**至此, 大功告成**。

## 报错自查

### 管道不存在

```bash
Install terminal quit with output: 过程试图写入的管道不存在。
Received install output: 过程试图写入的管道不存在。
```

**请检查你配置的 User 在云服务器上是否存在**

### Failed to set up dynamic port

一直卡在 `Waiting for port forwarding to be ready`

![20241224100725](https://i-blog.csdnimg.cn/img_convert/a28ac805ed977ce4c90bbfbd21407979.png)

**查看报错日志(Show log)** 可以发现有一条提示: Ensure that the sshd_config has `AllowTcpForwarding yes`
```bash
[09:55:58.987] Failed to set up socket for dynamic port forward to remote port 45333: Socket closed. TCP port forwarding may be disabled, or the remote server may have crashed. See the VS Code Server log above for details.
[09:55:58.989] Failed to set up socket for dynamic port forward to remote port 45333: Socket closed. TCP port forwarding may be disabled, or the remote server may have crashed. See the VS Code Server log above for details.
[09:55:59.007] > channel 3: open failed: administratively prohibited: open failed
> channel 4: open failed: administratively prohibited: open failed
[09:55:59.007] ERROR: TCP port forwarding appears to be disabled on the remote host. Ensure that the sshd_config has `AllowTcpForwarding yes`. Contact your system administrator if needed.
[09:55:59.029] > 
```

**解决方案**

1. 通过你购买云服务器的网站的控制台, 从网页进入云服务器的虚拟终端
2. 在终端运行命令 `
3. 检查 AllowTcpForwarding 的值, 如果为 no 的话, 修改为 yes, 保存退出. (涉及到一些 vim 的基本操, 请自行查阅)
4. 重启服务, 继续在网页终端执行命令 `systemctl restart sshd`.

```bash
vim /etc/ssh/sshd_config
systemctl restart sshd
```

![PixPin_2024-12-24_10-30-46](https://i-blog.csdnimg.cn/img_convert/1f9e4cc2e43aeef13930c391fbf2d6dc.gif)

## 参考文章

1. [零基础教程：轻松配置SSH免密登录](https://cloud.tencent.com/developer/article/2419935)
2. [解决：vscode连接服务器报错“Failed to set up dynamic port forwarding connection over SSH to the VS Code Server”](https://blog.csdn.net/weixin_54468359/article/details/144004739)
3. [VSCode连接Linux服务器出错](https://blog.csdn.net/hjmaAsC/article/details/107723029)
4. [vscode远程开发，含ssh密钥配置（免密登录）、客户端多私钥配置。](https://blog.csdn.net/hayreen/article/details/109225507)